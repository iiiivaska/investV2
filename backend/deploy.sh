#!/bin/bash

# ========================================
# ะกะะะะะข ะะะะะะะขะซะะะะะฏ INVESTV2 ะะ ะกะะะะะะ
# ========================================

set -e  # ะััะฐะฝะพะฒะบะฐ ะฟัะธ ะพัะธะฑะบะต

echo "๐ ะะฐัะธะฝะฐะตะผ ัะฐะทะฒะตัััะฒะฐะฝะธะต InvestV2 ะฝะฐ ัะตัะฒะตัะต..."

# ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต Docker ะธ Docker Compose
if ! command -v docker &> /dev/null; then
    echo "โ Docker ะฝะต ัััะฐะฝะพะฒะปะตะฝ. ะฃััะฐะฝะพะฒะธัะต Docker ัะฝะฐัะฐะปะฐ."
    exit 1
fi

if ! command -v docker-compose &> /dev/null; then
    echo "โ Docker Compose ะฝะต ัััะฐะฝะพะฒะปะตะฝ. ะฃััะฐะฝะพะฒะธัะต Docker Compose ัะฝะฐัะฐะปะฐ."
    exit 1
fi

# ะัะพะฒะตััะตะผ ะฟะพะดะบะปััะตะฝะธะต ะบ ะฒะฝะตัะฝะตะน ะฑะฐะทะต ะดะฐะฝะฝัั
echo "๐ ะัะพะฒะตััะตะผ ะฟะพะดะบะปััะตะฝะธะต ะบ ะฒะฝะตัะฝะตะน ะฑะฐะทะต ะดะฐะฝะฝัั..."
if ! docker run --rm postgres:15-alpine psql "postgresql://gen_user:%1umkt{~ZFy#m4@192.168.0.4:5432/investv2" -c "SELECT 1;" > /dev/null 2>&1; then
    echo "โ ะะต ัะดะฐะตััั ะฟะพะดะบะปััะธัััั ะบ ะฒะฝะตัะฝะตะน ะฑะฐะทะต ะดะฐะฝะฝัั. ะัะพะฒะตัััะต ะฝะฐัััะพะนะบะธ."
    exit 1
fi
echo "โ ะะพะดะบะปััะตะฝะธะต ะบ ะฑะฐะทะต ะดะฐะฝะฝัั ััะฟะตัะฝะพ"

# ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ัััะตััะฒัััะธะต ะบะพะฝัะตะนะฝะตัั
echo "๐ ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ัััะตััะฒัััะธะต ะบะพะฝัะตะนะฝะตัั..."
docker-compose down --remove-orphans

# ะฃะดะฐะปัะตะผ ััะฐััะต ะพะฑัะฐะทั (ะพะฟัะธะพะฝะฐะปัะฝะพ)
echo "๐งน ะัะธัะฐะตะผ ััะฐััะต ะพะฑัะฐะทั..."
docker system prune -f

# ะกะพะฑะธัะฐะตะผ ะธ ะทะฐะฟััะบะฐะตะผ ะบะพะฝัะตะนะฝะตัั
echo "๐จ ะกะพะฑะธัะฐะตะผ ะธ ะทะฐะฟััะบะฐะตะผ ะบะพะฝัะตะนะฝะตัั..."
docker-compose up --build -d

# ะะดะตะผ ะทะฐะฟััะบะฐ ะฟัะธะปะพะถะตะฝะธั
echo "โณ ะะดะตะผ ะทะฐะฟััะบะฐ ะฟัะธะปะพะถะตะฝะธั..."
sleep 10

# ะัะพะฒะตััะตะผ ััะฐััั ะบะพะฝัะตะนะฝะตัะพะฒ
echo "๐ ะกัะฐััั ะบะพะฝัะตะนะฝะตัะพะฒ:"
docker-compose ps

# ะัะพะฒะตััะตะผ health check
echo "๐ฅ ะัะพะฒะตััะตะผ health check..."
if curl -f http://localhost:8000/health > /dev/null 2>&1; then
    echo "โ ะัะธะปะพะถะตะฝะธะต ััะฟะตัะฝะพ ะทะฐะฟััะตะฝะพ!"
    echo "๐ API ะดะพัััะฟะตะฝ ะฟะพ ะฐะดัะตัั: http://localhost:8000"
    echo "๐ ะะพะบัะผะตะฝัะฐัะธั: http://localhost:8000/docs"
else
    echo "โ ะัะธะปะพะถะตะฝะธะต ะฝะต ะพัะฒะตัะฐะตั ะฝะฐ health check"
    echo "๐ ะะพะณะธ ะฟัะธะปะพะถะตะฝะธั:"
    docker-compose logs api
    exit 1
fi

echo "๐ ะะฐะทะฒะตัััะฒะฐะฝะธะต ะทะฐะฒะตััะตะฝะพ ััะฟะตัะฝะพ!"
