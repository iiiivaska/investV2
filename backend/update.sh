#!/bin/bash

# ========================================
# ะกะะะะะข ะะะะะะะะะะฏ INVESTV2 ะะ ะกะะะะะะ
# ========================================

set -e  # ะััะฐะฝะพะฒะบะฐ ะฟัะธ ะพัะธะฑะบะต

echo "๐ ะะฐัะธะฝะฐะตะผ ะพะฑะฝะพะฒะปะตะฝะธะต InvestV2..."

# ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต Docker ะธ Docker Compose
if ! command -v docker &> /dev/null; then
    echo "โ Docker ะฝะต ัััะฐะฝะพะฒะปะตะฝ."
    exit 1
fi

if ! command -v docker-compose &> /dev/null; then
    echo "โ Docker Compose ะฝะต ัััะฐะฝะพะฒะปะตะฝ."
    exit 1
fi

# ะกะพััะฐะฝัะตะผ ัะตะบััะธะต ะฝะฐัััะพะนะบะธ
echo "๐พ ะกะพััะฐะฝัะตะผ ัะตะบััะธะต ะฝะฐัััะพะนะบะธ..."
if [ -f .env ]; then
    cp .env .env.backup
    echo "โ ะะฐัััะพะนะบะธ ัะพััะฐะฝะตะฝั ะฒ .env.backup"
fi

# ะะฑะฝะพะฒะปัะตะผ ะบะพะด ะธะท Git
echo "๐ฅ ะะฑะฝะพะฒะปัะตะผ ะบะพะด ะธะท Git..."
if ! git pull origin main; then
    echo "โ ะัะธะฑะบะฐ ะฟัะธ ะพะฑะฝะพะฒะปะตะฝะธะธ ะบะพะดะฐ ะธะท Git"
    exit 1
fi

# ะะพัััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฝะฐัััะพะนะบะธ ะตัะปะธ ะฝัะถะฝะพ
if [ -f .env.backup ] && [ ! -f .env ]; then
    echo "๐ ะะพัััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฝะฐัััะพะนะบะธ..."
    cp .env.backup .env
fi

# ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะบะพะฝัะตะนะฝะตัั
echo "๐ ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะบะพะฝัะตะนะฝะตัั..."
docker-compose down

# ะฃะดะฐะปัะตะผ ััะฐััะต ะพะฑัะฐะทั
echo "๐งน ะัะธัะฐะตะผ ััะฐััะต ะพะฑัะฐะทั..."
docker system prune -f

# ะะตัะตัะพะฑะธัะฐะตะผ ะธ ะทะฐะฟััะบะฐะตะผ
echo "๐จ ะะตัะตัะพะฑะธัะฐะตะผ ะธ ะทะฐะฟััะบะฐะตะผ..."
docker-compose up --build -d

# ะะดะตะผ ะทะฐะฟััะบะฐ
echo "โณ ะะดะตะผ ะทะฐะฟััะบะฐ ะฟัะธะปะพะถะตะฝะธั..."
sleep 15

# ะัะพะฒะตััะตะผ ััะฐััั
echo "๐ ะกัะฐััั ะบะพะฝัะตะนะฝะตัะพะฒ:"
docker-compose ps

# ะัะพะฒะตััะตะผ health check
echo "๐ฅ ะัะพะฒะตััะตะผ health check..."
if curl -f http://localhost:8000/health > /dev/null 2>&1; then
    echo "โ ะะฑะฝะพะฒะปะตะฝะธะต ะทะฐะฒะตััะตะฝะพ ััะฟะตัะฝะพ!"
    echo "๐ API ะดะพัััะฟะตะฝ ะฟะพ ะฐะดัะตัั: http://localhost:8000"
    echo "๐ ะะพะบัะผะตะฝัะฐัะธั: http://localhost:8000/docs"
else
    echo "โ ะัะธะปะพะถะตะฝะธะต ะฝะต ะพัะฒะตัะฐะตั ะฟะพัะปะต ะพะฑะฝะพะฒะปะตะฝะธั"
    echo "๐ ะะพะณะธ ะฟัะธะปะพะถะตะฝะธั:"
    docker-compose logs api
    echo "๐ ะัะบะฐััะฒะฐะตะผัั ะบ ะฟัะตะดัะดััะตะน ะฒะตััะธะธ..."
    git reset --hard HEAD~1
    docker-compose up --build -d
    exit 1
fi

echo "๐ ะะฑะฝะพะฒะปะตะฝะธะต ะทะฐะฒะตััะตะฝะพ!"
